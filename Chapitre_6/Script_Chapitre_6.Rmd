---
title: "Ressources complémentaires - Chapitre 6"
author: "Rémi Anselme"
date: "`r Sys.time()`"
output:
  github_document:
    toc: yes
    toc_depth: 6
  html_document:
    toc: yes
    toc_depth: '6'
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

`%>%` <- magrittr::`%>%`

library(knitr)
library(readr)

# Figure and Table caption adapted from https://stackoverflow.com/questions/37116632/rmarkdown-html-number-figures: 
outputFormat = opts_knit$get("rmarkdown.pandoc.to"); # determine the output format of the document
if( is.null(outputFormat) ) outputFormat = ""; # probably not run within knittr
capTabNo = 1; capFigNo = 1; # figure and table caption numbering, for HTML do it manually
#Function to add the Table Number
capTab = function(x){
  if(outputFormat == 'html'){
    x = paste0("***Table ",capTabNo,".*** _",x,"_")
    capTabNo <<- capTabNo + 1
  }; x
}
#Function to add the Figure Number
capFig = function(x){
  if(outputFormat == 'html'){
    x = paste0("***Figure ",capFigNo,".*** _",x,"_")
    capFigNo <<- capFigNo + 1
  }; x
}
```

# Chapitre 6

**Les ressources supplémentaires du Chapitre 6 sont en cours de mise au propre.**

## TRILL vs. OTHER dans les grammaires

Pour répondre à cette question, cette section s’intéresse à ce que sont le TRILL et OTHER dans les grammaires. Il s’agit de comprendre comment les différents segments sont décrits. Pour cela, nous avons utilisé le corpus d’ouvrages de descriptions linguistiques que nous avions récoltés pour la réplication de l’étude de Winter et al. (2022) en chapitre 5.

```{r}
rough_r_data <- readr::read_csv("../Chapitre_5/data_replication/rough_r_data.csv")
```

### Méthodologie

Le fichier CSV data_4_terminology_graph a été obtenu en parcourant les notes prises dans les ressources complémentaires du Chapitre 5 en cherchant pour des mots-clefs pour les domaines de la phonétique et de la phonologie.

```{r}
dataTerm <- readr::read_delim("data_4_terminology_graph.csv", 
    "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  dplyr::mutate(revision = ifelse(stringr::str_detect(Phonology,"trill") & is.na(revision),"trilled",revision)) %>% 
  dplyr::filter(revision=="trilled" | revision=="other") %>% 
  dplyr::filter(!is.na(Phonology)) %>% 
  dplyr::mutate(Phonology = ifelse(revision=="trilled",paste0(Phonology,"; TRILL"),paste0(Phonology,"; OTHER")))

names(dataTerm)[1] <- "X1"

dataTerm %>% 
  dplyr::group_by(X1) %>% 
  dplyr::mutate(Phonology = stringr::str_split(Phonology,";{1,2}[:space:]"),
                Length = length(unlist(Phonology))) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(Length>1)-> dataTerm_2


data4graph <- NULL

for(i in 2:nrow(dataTerm_2)){
  
  (dataTerm_2[i,] %>% 
  dplyr::mutate(cart = list(combn(unlist(Phonology),2))))$cart[[1]] %>% t() %>% 
  as.data.frame() %>% 
  dplyr::mutate(X1 = dataTerm_2$X1[i],
                Language = dataTerm_2$Language[i],
                ISO_code = dataTerm_2$ISO_code[i],
                Phoible_code = dataTerm_2$Phoible_code[i],
                R_type = dataTerm_2$R_type[i],
                revision = dataTerm_2$revision[i]) -> data2add
  
  data4graph <- dplyr::bind_rows(data4graph,data2add)
}

data4graph <- dplyr::mutate(data4graph, V1 = as.character(V1),
                                        V2 = as.character(V2))
```

```{r}
concepts <- (stringr::str_c(stringr::str_replace_na(dataTerm$Phonology),collapse = "; ") %>% 
  stringr::str_split(";{1,2}[:space:]") %>% 
  table() %>% as.data.frame() %>% dplyr::rename(Freq = Freq,
                                                Phonology = 1) %>% 
  dplyr::filter(Freq>1))$Phonology
 
dataTerm_trill <- dataTerm %>% 
                    dplyr::filter(revision=="trilled")

dataTerm_other <- dataTerm %>% 
                    dplyr::filter(revision=="other")

stringr::str_c(stringr::str_replace_na(dataTerm_trill$Phonology),collapse = "; ") %>% 
  stringr::str_split(";[:space:]") %>% 
  table() %>% as.data.frame() %>% dplyr::rename(Freq_trill = Freq,
                                                Phonology = 1) %>% 
  dplyr::full_join(
    stringr::str_c(stringr::str_replace_na(dataTerm_other$Phonology),collapse = "; ") %>% 
  stringr::str_split(";[:space:]") %>% 
  table() %>% as.data.frame() %>% dplyr::rename(Freq_other = Freq,
                                                Phonology = 1),
  by="Phonology"
  ) %>% 
  dplyr::filter(Phonology %in% concepts) %>%
  dplyr::filter(Phonology != 'NA') %>% 
  dplyr::mutate(Freq_trill = ifelse(is.na(Freq_trill),0,Freq_trill),
                Freq_other = ifelse(is.na(Freq_other),0,Freq_other),
                sum_tot = log(abs(Freq_trill-Freq_other))) %>% 
  dplyr::filter(sum_tot>1) %>% 
  dplyr::mutate(Phonology = as.character(Phonology))-> data_norma
```


### Visualisation et résultats

```{r}
data4graph %>% 
  dplyr::mutate(V1 = ifelse(V1=="devoising","voiceless",V1),
                V2 = ifelse(V2=="devoising","voiceless",V2),
                V1 = ifelse(V1=="hardening","fortition",V1),
                V2 = ifelse(V2=="hardening","fortition",V2)) %>% 
  dplyr::filter(V1 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless","fortition") &
                  V2 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless","fortition")) %>%
  dplyr::count(V1,V2) %>% 
  dplyr::rename(source = V1,
                target = V2,
                weight = n) %>% 
  dplyr::filter(weight > 10) %>% 
  igraph::graph.data.frame(directed = FALSE) -> data2plotgraph_1
  #igraph::graph.data.frame(directed = FALSE,vertices = nodes_1) -> data2plotgraph_1

nodes_1 <- data.frame(name=igraph::V(data2plotgraph_1)$name,
                    cat=c("phono","phone","phono","phono","phone","phono","phono","phono",
      "phone","phono","phono","phono","phono","phono","phone","phono",
      "phone","phono","phone","phone","phone","phono","phone","phone",
      "class","class"),
                    audience.size=c((dplyr::filter(data_norma,Phonology%in%c(igraph::V(data2plotgraph_1)$name,"devoising","hardening") &
                                                     !Phonology%in%c("TRILL","OTHER")))$sum_tot,5,5))

data4graph %>% 
  dplyr::mutate(V1 = ifelse(V1=="devoising","voiceless",V1),
                V2 = ifelse(V2=="devoising","voiceless",V2),
                V1 = ifelse(V1=="hardening","fortition",V1),
                V2 = ifelse(V2=="hardening","fortition",V2)) %>% 
  dplyr::filter(V1 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless","fortition") &
                  V2 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless","fortition")) %>%
  dplyr::count(V1,V2) %>% 
  dplyr::rename(source = V1,
                target = V2,
                weight = n) %>% 
  dplyr::filter(weight > 10) %>% 
  igraph::graph.data.frame(directed = FALSE,vertices = nodes_1) -> data2plotgraph_1



# normalize the edge weights between 0-1
igraph::E(data2plotgraph_1)$weight <- igraph::E(data2plotgraph_1)$weight / max(igraph::E(data2plotgraph_1)$weight)


colrs <- c("gray50", "tomato", "gold")

igraph::V(data2plotgraph_1)$color <- colrs[as.factor(igraph::V(data2plotgraph_1)$cat)]

igraph::V(data2plotgraph_1)$size <- igraph::V(data2plotgraph_1)$audience.size*4.5

# play with different values of `k` until you get a reasonable looking graph
k = 15
```



```{r fig.cap=capFig("Graphe des associations des différents concepts de phonétique et de phonologie de grammaires décrivant des langues possédant un /r/ trillé « TRILL » ou un autre segment rhotique « OTHER ». Seuls les concepts qui sont présent plus de dix fois dans les grammaires sont représentés dans ce graphe. Les cercles jaunes correspondent à des concepts de phonologie, alors que ceux en rouge correspondant à des concepts de phonétique. La taille des cercles jaunes et rouges correspondent à la fréquence des concepts, et l’épaisseur des liens à la fréquence de l’association entre le concept et « TRILL » ou « OTHER ». Les différentes épaisseurs des liens et tailles des cercles ont été normalisées. Le graphe est obtenu graĉe au package igraph sur R (Csardi et Nepusz 2006)"), fig.width=20, fig.height=20}
set.seed(2022)
#cairo_pdf("graph_results.pdf",width = 20, height = 20, pointsize = 12)
data2plotgraph_1 %>%  
  plot(#layout=igraph::layout_with_graphopt(data2plotgraph_1, charge=0.02),
       layout=igraph::layout_with_lgl,
       #vertex.label.color="black",
       vertex.shape="circle",
       vertex.label.cex=3.75,
        edge.width = igraph::E(data2plotgraph_1)$weight * k,
       margin=c(-0.1,-0.1,-0.1,-0.1))
#dev.off()
```

```{r}
# data_reg <- readr::read_delim("data_4_terminology_graph.csv", 
#     "\t", escape_double = FALSE, trim_ws = TRUE) %>%
#   dplyr::mutate(revision = ifelse(stringr::str_detect(Phonology,"trill") & is.na(revision),"trilled",revision)) %>% 
#   dplyr::filter(revision=="trilled" | revision=="other") %>% 
#   dplyr::filter(!is.na(Phonology))
# 
# 
# names(data_reg)[1] <- "X1"
# 
# data_reg %>% 
#   dplyr::group_by(X1) %>% 
#   dplyr::mutate(Phonology = stringr::str_split(Phonology,"; "),
#                 lenght = length(unlist(Phonology))) -> max_sample
# 
# max(data_reg$lenght)
# 
# data_reg %>% 
#   dplyr::group_by(X1) %>% 
#   dplyr::mutate(Phonology = stringr::str_split(Phonology,"; "),
#                 Length = length(unlist(Phonology)),
#                 con_1=NA,
#                 con_2=NA,
#                 con_3=NA,
#                 con_4=NA,
#                 con_5=NA,
#                 con_6=NA,
#                 con_7=NA,
#                 con_8=NA,
#                 con_9=NA,
#                 con_10=NA,
#                 con_11=NA,
#                 con_12=NA,
#                 con_13=NA,
#                 con_14=NA) %>% 
#   dplyr::ungroup() -> data_reg
# 
# 
# for(i in 1:nrow(data_reg)){
#   for(j in 1:max(data_reg$Length)){
#     data_reg[[as.factor(paste("con_",as.character(j),sep=""))]][i] =
#       data_reg$Phonology[[i]][j]
#   }
# }

#save(data_reg, file = "data/data_reg.RData")
```

```{r}
load("data/data_reg.RData")

data_reg %>%
  tidyr::gather(key=para,value=valeur,c(con_1:con_14)) %>% 
  dplyr::mutate(para = 1) %>% 
  dplyr::group_by(Language) %>% 
  dplyr::select(-Phonology) %>% 
  dplyr::distinct() %>% 
  dplyr::left_join(rough_r_data,by=c("Language","ISO_code","Phoible_code","revision","R_type")) %>% 
  dplyr::select(-Meaning,-Form,-Trill,-Dataset) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(valeur,para,fill=0) -> data_regression_para

data_regression_para$revision <- as.factor(data_regression_para$revision)
```


```{r}
lme4::glmer(revision ~ trill + flap + tap + (1|Continent) + (1|Family),
            data=data_regression_para,
            family = binomial(logit)) -> f_all_full

summary(f_all_full)

lme4::glmer(revision ~ trill + (1|Continent) + (1|Family),
            data=data_regression_para,
            family = binomial(logit)) -> f_trill

summary(f_trill) 

lme4::glmer(revision ~ flap + (1|Continent) + (1|Family),
            data=data_regression_para,
            family = binomial(logit)) -> f_flap

summary(f_flap) 

lme4::glmer(revision ~ tap + (1|Continent)+ (1|Family),
            data=data_regression_para,
            family = binomial(logit)) -> f_tap

summary(f_tap)
```


```{r}
anova(f_all_full,f_flap)
anova(f_all_full,f_trill)
anova(f_all_full,f_tap)
```


```{r}
abs(AIC(f_trill) - AIC(f_flap))
abs(AIC(f_trill) - AIC(f_tap))
```

Les différences des AIC son systématiquement largement supérieures à 5.

### Exemples de processus phonologiques associés aux rhotiques

```{r}
load("../Chapitre_3/phoible.RData") 

languoid <- readr::read_delim("../Chapitre_3/languoid.csv", ",") %>% 
            dplyr::select(id,family_id,
                          parent_id,name,
                          level,latitude,
                          longitude,
                          iso639P3code)

languoid <- languoid %>% 
               dplyr::rename(Glottocode = id)

phoible <- phoible %>% 
               dplyr::left_join(languoid,
                                by="Glottocode")

data4graph %>% 
  dplyr::mutate(V1 = as.character(V1),
                V2 = as.character(V2)) %>% 
  dplyr::mutate(V1 = ifelse(V1=="devoising","voiceless",V1),
                V2 = ifelse(V2=="devoising","voiceless",V2)) %>% 
  dplyr::filter(V1 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless") &
                  V2 %in% c(data_norma$Phonology, "TRILL", "OTHER","voiceless")) -> data_word_trill
```

#### Exemple n°1 : Rhotiques et palatalisation

```{r}
data_word_trill_palatalization <- (dplyr::filter(data_word_trill,stringr::str_detect(V1,"palatal") |
                                                  stringr::str_detect(V2,"palatal")))$Language %>% unique()

phoible %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ʲ")|stringr::str_detect(Allophones,"ʲ")) %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ɽ|ɾ|r|ɻ")) %>% 
  dplyr::mutate(revision = ifelse(stringr::str_detect(Phoneme,"r"),"trilled","other"))%>% 
  dplyr::select(Glottocode,latitude,longitude,revision) %>% 
  dplyr::rename(Latitude = latitude,
                Longitude = longitude) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(Value_1 = "phoible_rough") -> phoible_palatalization

rough_r_data %>%
  dplyr::filter(Language %in% data_word_trill_palatalization) %>% 
  dplyr::select(Language,Latitude,Longitude,revision) %>% 
  dplyr::mutate(Value = "gramm_rough") %>% 
  dplyr::distinct() -> gramm_palatalization

dplyr::full_join(phoible_palatalization,gramm_palatalization) %>% 
  dplyr::mutate(Value = ifelse(is.na(Value),"Phoible","Grammars"),
                Language = ifelse(is.na(Language),Glottocode,Language)) %>% 
  dplyr::select(-Glottocode,-Value_1) -> full_data_palatalization
```

```{r}
phoible %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ʲ")|stringr::str_detect(Allophones,"ʲ")) %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ɽ|ɾ|r|ɻ")) %>% 
  dplyr::mutate(revision = ifelse(stringr::str_detect(Phoneme,"r"),"trilled","other")) %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"rʲ|r̥ʲ")==TRUE) %>% 
  dplyr::filter(family_id != "indo1319") -> table_pala_trill

length(unique(table_pala_trill$InventoryID))
```

```{r}
phoible %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ʲ")|stringr::str_detect(Allophones,"ʲ")) %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ɽ|ɾ|r|ɻ")) %>% 
  dplyr::mutate(revision = ifelse(stringr::str_detect(Phoneme,"r"),"trilled","other")) %>% 
  dplyr::filter(stringr::str_detect(Phoneme,"ʲ")==TRUE & stringr::str_detect(Phoneme,"r")==FALSE)  %>% 
  dplyr::filter(family_id != "indo1319") %>% 
  #dplyr::select(family_id,InventoryID) %>% dplyr::distinct() %>% 
  #dplyr::select(family_id) %>%  table()
  dplyr::filter(family_id == "atla1278")
```

